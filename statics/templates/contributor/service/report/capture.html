{% extends "contributor/service/index/index.html" %}
{% load static %}

{% block content %}

<style>
    .tabs {
        overflow: hidden;
        display: flex;
        gap: 1rem;
        margin: 1rem 0
    }

    .tablink {
        width: 100%;
        background-color: #003755;
        float: left;
        border: 1px solid #003755;
        outline: none;
        cursor: pointer;
        padding: 10px 15px;
        transition: background-color 0.3s;
        border-radius: 8px;
        color: white;
        font-weight: bold;
    }

    .tablink:hover {
        background-color: white;
        color: #003755
    }

    .tablink.active {
        background-color: #025c8d;
    }

    .tabcontent {
        display: none;
        padding: 20px;
        border: 1px solid #ccc;
        margin-top: -1px;
        border-radius: 8px;
    }

    .tabcontent h3 {
        margin-top: 0;
    }
</style>

<form action="" class="report-form" method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="tabs">
        <button class="tablink active flex gap-2 items-center text-lg" onclick="openTab('tab1')"><i class="fa-solid fa-circle-info"></i> Details </button>
        <button class="tablink flex gap-2 items-center text-lg" onclick="openTab('tab2')"> <i class="fa-solid fa-image"></i> Image</button>
        <button class="tablink flex gap-2 items-center text-lg" onclick="openTab('tab3')"><i class="fa-solid fa-location-dot"></i> Location</button>
    </div>

    <div id="tab1" class="tabcontent w-full">
        <div class="w-full flex flex-col">

            <label class="font-bold my-2" for="description">Description <i class="fa-solid fa-comments"></i></label>

            <textarea class="border-2 p-2 h-[8rem] rounded-md" type="text" value="" id="description" name="description"
                required>
                    </textarea>
        </div>

        <h1 class="font-bold my-2">Optional Details:</h1>

        <div class="flex flex-col gap-4">
            <input placeholder="Density" class="h-[2.5rem] border-2 p-2 rounded-md" type="number" value="" id="density" name="density">
            <input placeholder="Size" class="h-[2.5rem] border-2 p-2 rounded-md" type="number" value="" id="size" name="size">
            <select class="h-[2.5rem] border-2 p-2 rounded-md" name="depth" id="depth">
                <option disabled selected value>Depth</option>

                {% for depth in depths %}

                <option value="{{depth.id}}">{{depth}}</option>

                {% endfor %}
            </select>

            <select class="h-[2.5rem] border-2 p-2 rounded-md" name="weather" id="weather">
                <option disabled selected value>Weather</option>

                {% for weather in weathers %}
                <option value="{{weather.id}}">{{weather}}</option>
                {% endfor %}
            </select>
        </div>



        <!-- <div class = "card-body">
                <div class = "field">
                    <div class = "column">
                    

                        <label for = "depth">Depth</label> 
                            
                        <div class = "depth">
                            <input type = "text" value = "" id = "depth" name = "depth">
                                
                            <i class = "fa-solid fa-arrow-down-wide-short"></i>
                        </div>

                     
                    </div>

                    <div class = "column">
                        <label for = "density">Density / Square Meter</label> 
                            
                        <div class = "density">
                            <input type = "number" value = "" id = "density" name = "density">
                                
                            <i class = "fa-solid fa-braille"></i>
                        </div>

                        <label for = "weather">Weather</label> 
                            
                        <div class = "weather">
                            <input type = "text" value = "" id = "weather" name = "weather">
                                
                            <i class = "fa-solid fa-temperature-high"></i>
                        </div>

                    
                    </div>
                </div>

               
            </div> -->
<div class="w-full flex justify-end my-[2rem]">
    <button type="button" class="border-2 max-w-[15rem] h-[3rem] bg-[#003755] text-white font-bold hover:bg-white hover:border-blue-600 hover:text-blue-600 text-center cursor-pointer p-2 rounded-lg" onclick="nextTab('tab1')">Next</button>

</div>

    </div>

    <div id="tab2" class="tabcontent w-full" style="display:none;">

        <div class="w-full border-2 p-2 my-2 rounded-md flex-col flex items-center">
            <label for="post-photo" class="capture-photo hover:border-2 w-full my-2 h-[3rem] bg-[#003755] text-white font-bold hover:bg-white hover:border-blue-600 hover:text-blue-600 text-center cursor-pointer p-2 rounded-lg">Capture</label>

            <input type="file" class="post-photo w-full border-2 p-2 rounded-md" name="post_photos" accept="image/*" capture="environment" required>
        </div>


        <div class="flex items-center justify-between w-full h-[4rem] border-2 p-2 rounded-md">
            <label for="capture-date">Capture Date</label>

            <div class="cursor-pointer">
                <input type="datetime-local" value="" id="capture-date" name="capture_date" required>
            </div>
        </div>
        <div class="report-gallery">
            <img class="gallery-photo" src="{% static 'assets/posts/default.png' %}">
        </div>

      


        <div class="w-full flex justify-end my-[2rem]">
            <button type="button" class="border-2 max-w-[15rem] h-[3rem] bg-[#003755] text-white font-bold hover:bg-white hover:border-blue-600 hover:text-blue-600 text-center cursor-pointer p-2 rounded-lg" onclick="nextTab('tab2')">Next</button>
        
        </div>
    </div>

    <div id="tab3" class="tabcontent" style="display:none;">
        <div class="latitude flex justify-between w-full items-center h-[3rem] border-2 rounded-md mb-2 p-4">
            <input type="text" value="" id="latitude" name="latitude">

            <i class="fa-solid fa-map-location-dot"></i>
        </div>

        <div class="longitude flex justify-between w-full items-center h-[3rem] border-2 rounded-md mb-2 p-4">
            <input type="text" value="" id="longitude" name="longitude">

            <i class="fa-solid fa-map-location-dot"></i>
        </div>

        <select class="h-[2.5rem] border-2 p-2 rounded-md my-2 w-full" name="location" id="location">
            <option disabled selected value="">Choose location</option>

            {% for location in locations %}

            <option value="{{location.id}}">{{location}}</option>

            {% endfor %}
        </select>

        <div class="map w-full">
            <div class="report-map w-full">
            </div>
        </div>


        <div class="flex w-full justify-end my-2">
            <div
                class="border-2 w-fit h-[3rem] bg-green-500 text-white font-bold hover:bg-white hover:border-green-600 hover:text-green-600 text-center cursor-pointer p-2 rounded-lg">
                <a class="refresh-map" onclick="refreshMap()">Refresh</a>
            </div>
        </div>

        <div class="flex w-full justify-center">
            <div
                class="border-2 w-[15rem] h-[3rem] bg-[#003755] text-white font-bold hover:bg-white hover:border-blue-600 hover:text-blue-600 text-center cursor-pointer p-2 rounded-lg">
                <a class="save-report" type="submit">Save</a>
            </div>
        </div>
    </div>
    <!--         
        <div class = "report" id = "capture">
            <div class = "card-header">
                <header>Add required information</header>
            </div>

          
        </div> -->

    <!-- <div class = "report" id = "capture">
            <div class = "card-header">
                <header>Add optional information</header>
            </div>

            <div class = "card-body">
                <div class = "field">
                    <div class = "column">
                        <label for = "size">Size / Centimeter</label> 
                            
                        <div class = "size">
                            <input type = "number" value = "" id = "size" name = "size">
                                
                            <i class = "fa-solid fa-draw-polygon"></i>
                        </div>

                        <label for = "depth">Depth</label> 
                            
        

                        <select name = "depth" id = "depth">
                            <option disabled selected value>Choose depth</option>

                            {% for depth in depths %}

                            <option value="{{depth.id}}">{{depth}}</option>
                            
                            {% endfor %}
                        </select>
                    </div>

                    <div class = "column">
                        <label for = "density">Density / Square Meter</label> 
                            
                        <div class = "density">
                            <input type = "number" value = "" id = "density" name = "density">
                                
                            <i class = "fa-solid fa-braille"></i>
                        </div>

                        <label for = "weather">Weather</label> 
                            
            

                        <select name = "weather" id = "weather">
                            <option disabled selected value>Choose weather</option>

                            {% for weather in weathers %}
                                <option value="{{weather.id}}">{{weather}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class = "button">
                    <a class = "save-report" type = "submit">Save</a>
                </div>   
            </div>
        </div> -->
</form>

{% if messages %}
{% for message in messages %}
{% if message.tags == "info" %}
<script>Swal.fire({ title: "Hey!", text: "{{message}}", background: "#FFFFFF", icon: "warning", iconColor: "#154360", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#154360", customClass: { confirmButton: "info-button", title: "title" } })</script>

{% elif message.tags == "success" %}
<script>Swal.fire({ title: "Yay!", text: "{{message}}", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: { confirmButton: "success-button", title: "title" } })</script>

{% else %}
<script>Swal.fire({ title: "Oops!", text: "{{message}}", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: { confirmButton: "error-button", title: "title" } })</script>

{% endif %}
{% endfor %}
{% endif %}

<script>
    const browsePhoto = document.querySelector(".post-photo");

    const reportGallery = document.querySelector(".report-gallery");

    browsePhoto.addEventListener("change", (event) => {
        const reportFiles = event.target.files;

        reportGallery.innerHTML = "";

        for (let i = 0; i < reportFiles.length; i++) {
            const photoObject = reportFiles[i];

            const photoElement = document.createElement("img");

            photoElement.classList.add("gallery-photo");

            photoElement.src = URL.createObjectURL(photoObject);

            reportGallery.appendChild(photoElement);
        }
    });
</script>

<script>
    document.querySelector(".post-photo").addEventListener("change", function () {
        for (var i = 0; i < this.files.length; i++) {
            var reportFile = this.files[i];

            var modifiedDate = reportFile.lastModifiedDate;

            var formattedDate = modifiedDate.toISOString().slice(0, 16);

            document.getElementById("capture-date").value = formattedDate;
        };
    });
</script>

<script>
    var map;

    var report;

    function revealMap() {
        var reportMap = document.getElementsByClassName("report-map")[0];

        var background = L.tileLayer("http://{s}.google.com/vt?lyrs=s,h&x={x}&y={y}&z={z}", { minZoom: 11, maxZoom: 15, subdomains: ["mt0", "mt1", "mt2", "mt3"], attribution: "Google" });

        map = L.map(reportMap, { zoomControl: true, scrollWheelZoom: false, dragging: true, maxBounds: [[5.3, 124.3], [6.3, 126.3]], layers: [background] }).setView([5.9656, 125.1929], 11);

        map.attributionControl.setPosition("bottomleft");

        var starfish = L.icon({ iconUrl: "{% static 'assets/icons/marker.png' %}", iconSize: [30, 30], iconAnchor: [15, 15] });

        report = L.marker([5.9656, 125.1929], { draggable: true, icon: starfish }).addTo(map);

        report.on("drag", function (event) {
            var position = event.target.getLatLng();

            updateCoordinates(position.lat, position.lng);
        });

        report.on("dragend", function (event) {
            var position = event.target.getLatLng();

            updateCoordinates(position.lat, position.lng);
        });

        var defaultLatitude = report.getLatLng().lat;

        var defaultLongitude = report.getLatLng().lng;

        updateCoordinates(defaultLatitude, defaultLongitude);

        fetchLocation();
    };

    function updateCoordinates(latitude, longitude) {
        var latitudeInput = document.getElementById("latitude");

        var longitudeInput = document.getElementById("longitude");

        latitudeInput.value = latitude.toFixed(6);

        longitudeInput.value = longitude.toFixed(6);
    };
</script>

<script>
    function refreshMap() {
        map.setView([5.9656, 125.1929], 11);
    };

    document.querySelector(".refresh-map").addEventListener("click", refreshMap);
</script>

<script>
    function fetchLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(checkPosition);

        } else {
            Swal.fire({ title: "Oops!", text: "The location is not supported and cannot be given to COTSEye.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: { confirmButton: "error-button", title: "title" } });
        };
    };

    function checkPosition(position) {
        const maximumLatitude = 6.3;

        const minimumLatitude = 5.3;

        const maximumLongitude = 126.3;

        const minimumLongitude = 124.3;

        const latitude = position.coords.latitude;

        const longitude = position.coords.longitude;

        if (latitude < minimumLatitude || latitude > maximumLatitude || longitude < minimumLongitude || longitude > maximumLongitude) {
            Swal.fire({ title: "Oops!", text: "The location given to COTSEye incorporated coordinates out of bounds.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: { confirmButton: "error-button", title: "title" } });

            document.querySelector(".capture-photo").addEventListener("click", function () {
                Swal.fire({ title: "Oops!", text: "The location given to COTSEye incorporated coordinates out of bounds.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: { confirmButton: "error-button", title: "title" } });
            });

        } else {
            updateCoordinates(latitude, longitude);

            report.setLatLng([latitude, longitude]);

            map.setView([latitude, longitude], 11);

            document.querySelector(".capture-photo").addEventListener("click", function () {
                document.querySelector(".post-photo").click();
            });

        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        revealMap();

        const captureButton = document.querySelector(".post-photo");

        if (captureButton) {
            captureButton.addEventListener("click", function (event) {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    Swal.fire({ title: "Oops!", text: "The camera is not supported and cannot be given to COTSEye.", background: "#FFFFFF", icon: "error", iconColor: "#C90016", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#C90016", customClass: { confirmButton: "error-button", title: "title" } });
                };
            });
        }
    });
</script>

<script>
    document.querySelector(".save-report").onclick = function (event) {
        event.preventDefault();

        if (!navigator.onLine) {
            const username = "{{request.user.username}}";

            Swal.fire({ title: "Hey!", text: username + ", " + "your information input was recorded offline for COTSEye. Kindly visit the current page again if back online.", background: "#FFFFFF", icon: "warning", iconColor: "#154360", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#154360", customClass: { confirmButton: "info-button", title: "title" } }).then(() => {
                location.reload();
            });

        } else {
            document.querySelector(".report-form").submit();
        };
    };
</script>

<script>

    function openTab(tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        event.currentTarget.classList.add("active");
    }

    function nextTab(currentTabId) {
        var currentTab = document.getElementById(currentTabId);
        var nextTab = currentTab.nextElementSibling;
        openTab(nextTab.id);
    }

    openTab('tab1');

    const indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;

    const request = indexedDB.open("cotseye", 1);

    request.onupgradeneeded = (event) => {
        const cotseye = event.target.result;

        const cotseye_schema = cotseye.createObjectStore("cotseye_schema", { autoIncrement: true });
    };

    request.onsuccess = (event) => {
        const cotseye = event.target.result;

        const form = document.querySelector(".report-form");

        {% if draft_post %}
        const id = "{{draft_post.id}}";
        {% endif %}

        const user = "{{request.user.id}}";

        if (!navigator.onLine) {
            document.querySelector(".post-photo").addEventListener("change", () => {
                const files = document.querySelector(".post-photo").files;

                for (let i = 0; i < files.length; i++) {
                    const reader = new FileReader();

                    reader.addEventListener("load", (event) => {
                        postPhotos.push(event.target.result);
                    });

                    reader.readAsDataURL(files[i]);
                };
            });

            const postPhotos = [];

            document.querySelector(".save-report").addEventListener("click", (event) => {
                event.preventDefault();

                const information = new FormData(form);

                const captureDate = information.get("capture_date");

                const description = information.get("description");

                const latitude = information.get("latitude");

                const longitude = information.get("longitude");

                const location = information.get("location");

                const size = information.get("size");

                const depth = information.get("depth");

                const density = information.get("density");

                const weather = information.get("weather");

                const transaction = cotseye.transaction("cotseye_schema", "readwrite");

                const cotseye_schema = transaction.objectStore("cotseye_schema");

                const post = {            
                        {% if draft_post %}
                id: parseInt(id),
                    {% endif %}        

                        user: parseInt(user),

                capture_date: new Date(captureDate),

                description: description,

                post_photos: postPhotos,

                latitude: parseFloat(latitude),

                longitude: parseFloat(longitude),

                location: parseInt(location),

                size: parseInt(size),

                depth: parseInt(depth),

                density: parseInt(density),

                weather: parseInt(weather)
                    };

        cotseye_schema.add(post);
    }); 
            };

    if (navigator.onLine) {
        const transaction = cotseye.transaction("cotseye_schema", "readonly");

        const cotseye_schema = transaction.objectStore("cotseye_schema");

        const post = cotseye_schema.getAll();

        post.onsuccess = (event) => {
            const information = event.target.result;

            if (information && information.length > 0) {
                const json = JSON.stringify(information);

                const token = "{{csrf_token}}"

                {% if draft_post %}
                fetch("{% url 'Contributor Service Report Update Fetch' %}", {
                    method: "POST",

                    headers: { "Content-Type": "application/json", "X-CSRFToken": token },

                    body: json

                }).then(() => {
                    const request = indexedDB.open("cotseye", 1);

                    request.onsuccess = (event) => {
                        const cotseye = event.target.result;

                        const transaction = cotseye.transaction("cotseye_schema", "readwrite");

                        const cotseye_schema = transaction.objectStore("cotseye_schema");

                        cotseye_schema.clear();

                        const username = "{{request.user.username}}";

                        Swal.fire({ title: "Yay!", text: username + ", " + "your information input recorded offline was delivered to COTSEye.", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: { confirmButton: "success-button", title: "title" } }).then(() => {
                            window.location.href = "{% url 'Contributor Service Home' %}";
                        });
                    };
                });

                {% else %}
                fetch("{% url 'Contributor Service Report Fetch' %}", {
                    method: "POST",

                    headers: { "Content-Type": "application/json", "X-CSRFToken": token },

                    body: json

                }).then(() => {
                    const request = indexedDB.open("cotseye", 1);

                    request.onsuccess = (event) => {
                        const cotseye = event.target.result;

                        const transaction = cotseye.transaction("cotseye_schema", "readwrite");

                        const cotseye_schema = transaction.objectStore("cotseye_schema");

                        cotseye_schema.clear();

                        const username = "{{request.user.username}}";

                        Swal.fire({ title: "Yay!", text: username + ", " + "your information input recorded offline was delivered to COTSEye.", background: "#FFFFFF", icon: "success", iconColor: "#698F3F", allowOutsideClick: false, allowEscapeKey: false, confirmButtonColor: "#698F3F", customClass: { confirmButton: "success-button", title: "title" } }).then(() => {
                            window.location.href = "{% url 'Contributor Service Home' %}";
                        });
                    };
                });
                {% endif %}
            };
        };
    };
        };
</script>
{% endblock content %}